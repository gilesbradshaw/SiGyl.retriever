(function(){define(["Q","linq","breeze","store","utils"],function(e,d,a,f,g){var b,c;c=function(k){var h,i,j;h=e.defer();i=new a.EntityManager(k);j=i.fetchMetadata();j.done(function(l){return h.resolve({key:l.schema.entityContainer.name,manager:i,metaData:l})});j["catch"](function(){return h.reject()});return h.promise};b=void 0;return{initMe:function(i){var h;h=e.all(d.From(i).Select(function(j){return c(j)}).ToArray());return b=h.then(function(n){var l,m,j,k;l=[];for(j=0,k=n.length;j<k;j++){m=n[j];m.store=new (f.getMe())(g.getMe().processModel(m.metaData.schema))}return e.all(l).then(function(){var o;o=function(p){return d.From(n).Single(function(q){return d.From(q.metaData.schema.entityContainer.entitySet).SingleOrDefault(void 0,function(r){return r.entityType===("Self."+p)})})};return{getStore:function(p){return o(p).store},getType:function(q){var p;m=o(q);p=d.From(m.metaData.schema.entityContainer.entitySet).Single(function(r){return r.entityType===("Self."+q)}).name;return{entityContainer:p,query:a.EntityQuery.from(p),executeQuery:function(r){return m.manager.executeQuery(r)},manager:m.manager,store:m.store,entityType:d.From(m.metaData.schema.entityType).Single(function(r){return r.name===q})}},getCollectionType:function(q){var p;m=o(q);p=d.From(m.metaData.schema.entityType).Single(function(r){return r.name===q});return{manager:m.manager,entityType:p,collectionManager:function(r){var s,t;t=g.getMe().getDependent(p,r);s=d.From(m.metaData.schema.entityContainer.entitySet).Single(function(u){return u.entityType.split(".")[1]===t.type()}).name;return{query:function(u){return a.EntityQuery.from(s).inlineCount().where(t.id(),"==",u)}}}}}}})})},getMe:function(){return b}}})}).call(this);
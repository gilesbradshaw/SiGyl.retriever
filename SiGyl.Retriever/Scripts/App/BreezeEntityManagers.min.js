(function(){define(["Q","linq","breeze","store","utils","source","rx.binding"],function(e,d,a,i,j,h,g){var b,c,f;c=function(n){var k,l,m;k=e.defer();l=new a.EntityManager(n);m=l.fetchMetadata();m.done(function(o){return k.resolve({key:o.schema.entityContainer.name,manager:l,metaData:o})});m["catch"](function(){return k.reject()});return k.promise};b=void 0;f=void 0;return{initMe:function(l){var k;f={};k=e.all(d.From(l).Select(function(m){return c(m)}).ToArray());return b=k.then(function(q){var o,p,m,n;o=[];for(m=0,n=q.length;m<n;m++){p=q[m];p.store=new (i.getMe())(j.getMe().processModel(p.metaData.schema))}return e.all(o).then(function(){return h.initMe().then(function(){var r,s;h.getMe().on("change",function(v,w,u){var t;t=r.getStore(w.split(".")[0]).changeData(v,w,u).done;if(t&&f[""+w+":.:"+v]){return f[""+w+":.:"+v].observer.onNext(t.value)}});h.getMe().on("delete",function(u,w,t){var v;return v=r.getStore(w.split(".")[0]).deleteData(u,w,t)});s=function(t){return d.From(q).Single(function(u){return d.From(u.metaData.schema.entityContainer.entitySet).SingleOrDefault(void 0,function(v){return v.entityType===("Self."+t)})})};return r={subscriber:function(u){var t;if(!f[u]){t=g.Observable.create(function(v){f[u].observer=v;return function(){delete f[u];return h.getMe().invoke("NewLeave",u)}});f[u]={subject:t,share:t.share(),subscriptionDeferred:e.defer()};h.getMe().invoke("NewJoin",u).done(function(){if(f[u]){return f[u].subscriptionDeferred.resolve(function(){return f[u].share})}}).fail(function(v){if(f[u]){return f[u].subscriptionDeferred.reject(v)}})}return f[u].subscriptionDeferred.promise},getStore:function(t){return s(t).store},getType:function(v){var t,u;p=s(v);u=d.From(p.metaData.schema.entityType).Single(function(w){return w.name===v});t=d.From(p.metaData.schema.entityContainer.entitySet).Single(function(w){return w.entityType===("Self."+v)}).name;return{entityContainer:t,query:a.EntityQuery.from(t),executeQuery:function(w){return p.manager.executeQuery(w)},manager:p.manager,store:p.store,entityType:u,collectionManager:function(w){var x,y;y=j.getMe().getDependent(u,w);x=d.From(p.metaData.schema.entityContainer.entitySet).Single(function(z){return z.entityType.split(".")[1]===y.type()});return{entityType:u.model.entityTypes[x.entityType.split(".")[1]],entityContainer:x.name,query:function(z){return a.EntityQuery.from(x.name).inlineCount().where(y.id(),"==",z)}}},singleManager:function(x){var w,y;w=j.getMe().getPrincipal(u,x);y=d.From(p.metaData.schema.entityContainer.entitySet).Single(function(z){return z.entityType.split(".")[1]===w.type()});return{entityType:u.model.entityTypes[y.entityType.split(".")[1]],entityContainer:y.name,query:function(z){return a.EntityQuery.from(y.name).inlineCount().where("Id","==",z[w.id()]())}}}}},getCollectionType:function(u){var t;p=s(u);t=d.From(p.metaData.schema.entityType).Single(function(v){return v.name===u});return{manager:p.manager,entityType:t,collectionManager:function(v){var w,x;x=j.getMe().getDependent(t,v);w=d.From(p.metaData.schema.entityContainer.entitySet).Single(function(y){return y.entityType.split(".")[1]===x.type()}).name;return{query:function(y){return a.EntityQuery.from(w).inlineCount().where(x.id(),"==",y)}}}}}}})})})},getMe:function(){return b}}})}).call(this);
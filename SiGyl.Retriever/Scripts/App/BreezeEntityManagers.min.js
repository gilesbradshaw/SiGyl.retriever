(function(){define(["jquery","Q","linq","breeze","store","utils","source","rx.binding"],function(a,f,e,b,j,k,i,h){var c,d,g;d=function(o){var l,m,n;l=f.defer();m=new b.EntityManager(o);n=m.fetchMetadata();n.done(function(p){return l.resolve({key:p.schema.entityContainer.name,manager:m,metadata:p})});n["catch"](function(){return l.reject()});return l.promise};c=void 0;g=void 0;return{initMe:function(m){var l;g={};l=f.all(e.From(m).Select(function(n){return d(n)}).ToArray());return c=l.then(function(r){var p,q,n,o;p=[];for(n=0,o=r.length;n<o;n++){q=r[n];q.store=new (j.getMe())(k.getMe().processModel(q.metadata.schema));q.executingQueries={}}return f.all(p).then(function(){return i.initMe().then(function(){var s,t,u;i.getMe().on("change",function(y,B,w){var v,x,z,A,C;C=s.getType(B.split(".")[0]);if(B.split(".").length>1){C=C.collectionManager(B.split(".")[1])}x=C.manager.metadataStore.getEntityType(C.entityType.name);z=x.createEntity(w);C.manager.attachEntity(z,b.EntityState.Unchanged,b.MergeStrategy.OverwriteChanges);v=s.getStore(B.split(".")[0]).changeData(y,B,w);if(v){if(B.split(".").length===2){A=""+(B.split(".")[0])+":."+(B.split(".")[1])+":"+y}else{A=""+B+":.:"+y}if(g[A]){return g[A].observer.onNext({changed:v.value})}}});i.getMe().on("delete",function(w,y,v){var x;return x=s.getStore(y.split(".")[0]).deleteData(w,y,v)});t=function(v){return e.From(r).Single(function(w){return e.From(w.metadata.schema.entityContainer.entitySet).SingleOrDefault(void 0,function(x){return x.entityType===("Self."+v)})})};u=function(x,w,y,v){return{manager:x.manager,namespace:x.metadata.schema.namespace,entityContainer:v,query:y,executeQuery:function(A){var B,z;B=A._toUri(x.manager.metadataStore);return(z=x.executingQueries)[B]||(z[B]=x.manager.executeQuery(A).then(function(C){delete x.executingQueries[B];return a.extend(C,{storedResults:C.results.map(function(D){return x.store.mergeData(w.name,D)})})}))},entityType:w}};return s={subscriber:function(w){var v;if(!g[w]){v=h.Observable.create(function(x){g[w].observer=x;return function(){delete g[w];return i.getMe().invoke("NewLeave",w)}});g[w]={subject:v,share:v.share(),subscriptionDeferred:f.defer()};i.getMe().invoke("NewJoin",w).done(function(){if(g[w]){return g[w].subscriptionDeferred.resolve(function(){return g[w].share})}}).fail(function(x){if(g[w]){return g[w].subscriptionDeferred.reject(x)}})}return g[w].subscriptionDeferred.promise},getStore:function(v){return t(v).store},getType:function(x){var v,w;q=t(x);w=e.From(q.metadata.schema.entityType).Single(function(y){return y.name===x});v=e.From(q.metadata.schema.entityContainer.entitySet).Single(function(y){return y.entityType===("Self."+x)}).name;return a.extend(u(q,w,(function(){return b.EntityQuery.from(v)}),v),{subscriptionDefinition:function(y){return""+w.name+":.:"+(y.Id())},collectionManager:function(y){var z,A,B,C;B=k.getMe().getDependent(w,y);z=e.From(q.metadata.schema.entityContainer.entitySet).Single(function(D){return D.entityType.split(".")[1]===B.type()});A=w.model.entityTypes[z.entityType.split(".")[1]];C=function(D){var E;E=b.EntityQuery.from(z.name).inlineCount().where(B.id(),"==",D);E=E.where(B.id(),"==",D);return E};return a.extend(u(q,A,C,z),{subscriptionDefinition:function(D){return""+w.name+":."+y+":"+(D.Id())}})},singleManager:function(B){var y,z,A,C;z=k.getMe().getPrincipal(w,B);y=k.getMe().getDependent(w,B);C=e.From(q.metadata.schema.entityContainer.entitySet).Single(function(D){return D.entityType.split(".")[1]===z.type()});w=w.model.entityTypes[C.entityType.split(".")[1]];A=function(D){return b.EntityQuery.from(C.name).inlineCount().where("Id","==",D[y.id()]())};return a.extend(u(q,w,A,C),{subscriptionDefinition:function(D){return""+w.name+":.:"+(D[y.id()]())}})}})}}})})})},getMe:function(){return c}}})}).call(this);
(function(){define(["jquery","knockout","Q","b64","linq","breeze","store","utils","source","rx.binding"],function(a,f,h,b,g,c,l,m,k,j){var d,e,i;e=function(q){var n,o,p;n=h.defer();o=new c.EntityManager(q);p=o.fetchMetadata();p.done(function(r){return n.resolve({key:r.schema.entityContainer.name,manager:o,metadata:r})});p["catch"](function(){return n.reject()});return n.promise};d=void 0;i=void 0;return{initMe:function(o){var n;i={};n=h.all(g.From(o).Select(function(p){return e(p)}).ToArray());return d=n.then(function(t){var r,s,p,q;r=[];for(p=0,q=t.length;p<q;p++){s=t[p];s.store=new (l.getMe())(m.getMe().processModel(s.metadata.schema));s.executingQueries={}}return h.all(r).then(function(){return k.initMe().then(function(){var u,v,w;k.getMe().on("change",function(B,E,z){var x,y,A,C,D,F;F=u.getType(E.split(".")[0]);if(E.split(".").length>1){F=F.collectionManager(E.split(".")[1])}if(F.entityType.data[z.Id]){if(b.compare(f.utils.unwrapObservable(z.Timestamp),f.utils.unwrapObservable(F.entityType.data[z.Id].Timestamp))){return}}A=F.breezeEntityType;C=A.createEntity(z);x=F.manager.attachEntity(C,c.EntityState.Unchanged,c.MergeStrategy.OverwriteChanges);y=u.getStore(E.split(".")[0]).changeData(B,E,C);if(y){if(E.split(".").length===2){D=""+(E.split(".")[0])+":."+(E.split(".")[1])+":"+B}else{D=""+E+":.:"+B}if(i[D]){return i[D].observer.onNext({changed:y.value})}}});k.getMe().on("delete",function(A,D,x){var z,y,B,C,E;E=u.getType(D.split(".")[0]);if(D.split(".").length>1){E=E.collectionManager(D.split(".")[1])}z=E.breezeEntityType;y=E.manager.getEntityByKey(z,x.Id);if(E.manager.detachEntity(y,c.EntityState.Unchanged,c.MergeStrategy.OverwriteChanges)){C=u.getStore(D.split(".")[0]).deleteData(A,D,y);if(C){if(D.split(".").length===2){B=""+(D.split(".")[0])+":."+(D.split(".")[1])+":"+A}else{B=""+D+":.:"+A}if(i[B]){return i[B].observer.onNext({deleted:y})}}}});v=function(x){return g.From(t).Single(function(y){return g.From(y.metadata.schema.entityContainer.entitySet).SingleOrDefault(void 0,function(z){return z.entityType===("Self."+x)})})};w=function(z,y,B,A,x){return{breezeEntityType:z.manager.metadataStore.getEntityType(y.name),manager:z.manager,namespace:z.metadata.schema.namespace,entityContainer:x,query:B,predicate:A,executeQuery:function(D){var E,C;E=D._toUri(z.manager.metadataStore);return(C=z.executingQueries)[E]||(C[E]=z.manager.executeQuery(D).then(function(F){delete z.executingQueries[E];return a.extend(F,{storedResults:F.results.map(function(G){return z.store.mergeData(y.name,G)})})}))},entityType:y}};return u={subscriber:function(y){var x;return x=h.all(y.map(function(A){var z,B;B=[];if(!i[A]){z=j.Observable.create(function(C){i[A].observer=C;return function(){delete i[A];return k.getMe().invoke("NewLeave",[A])}});i[A]={subject:z,share:z.share(),subscriptionDeferred:h.defer()};B.push(A)}if(B.length){k.getMe().invoke("NewJoin",B).done(function(){return B.map(function(C){if(i[C]){return i[C].subscriptionDeferred.resolve(function(){return i[C].share})}})}).fail(function(C){return B.map(function(D){if(i[D]){return i[D].subscriptionDeferred.reject(C)}})})}return i[A].subscriptionDeferred.promise}))},getStore:function(x){return v(x).store},getType:function(z){var x,y;s=v(z);y=g.From(s.metadata.schema.entityType).Single(function(A){return A.name===z});x=g.From(s.metadata.schema.entityContainer.entitySet).Single(function(A){return A.entityType===("Self."+z)}).name;return a.extend(w(s,y,c.EntityQuery.from(x),void 0,x),{subscriptionDefinition:function(A){return""+y.name+":.:"+(A.Id())},collectionManager:function(A){var B,C,D,E,F;D=m.getMe().getDependent(y,A);B=g.From(s.metadata.schema.entityContainer.entitySet).Single(function(G){return G.entityType.split(".")[1]===D.type()});C=y.model.entityTypes[B.entityType.split(".")[1]];F=c.EntityQuery.from(B.name).inlineCount();E=function(G){return new c.Predicate(D.id(),"==",G.Id())};return a.extend(w(s,C,F,E,B),{subscriptionDefinition:function(G){return""+y.name+":."+A+":"+(G.Id())}})},interModelManager:function(D){var A,B,C,E,F;F=g.From(y.interModelRelations).Single(function(G){return G.name===D});B=v(F.name);A=B.metadata.schema.entityTypes[F.name];E=c.EntityQuery.from(F.collection).inlineCount();C=function(G){return new c.Predicate(F.foreignKey,"==",G.Id())};return a.extend(w(B,A,E,C,F.collection),{subscriptionDefinition:function(G){return""+F.name+":.:"+(G.Id())}})},singleManager:function(E){var A,B,C,D,F;C=m.getMe().getPrincipal(y,E);A=m.getMe().getDependent(y,E);F=g.From(s.metadata.schema.entityContainer.entitySet).Single(function(G){return G.entityType.split(".")[1]===C.type()});y=y.model.entityTypes[F.entityType.split(".")[1]];D=c.EntityQuery.from(F.name).inlineCount();B=function(G){return new c.Predicate("Id","==",G[A.id()]())};return a.extend(w(s,y,D,B,F),{subscriptionDefinition:function(G){return""+y.name+":.:"+(G[A.id()]())}})}})}}})})})},getMe:function(){return d}}})}).call(this);
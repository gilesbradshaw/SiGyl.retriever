(function(){define(["Q","linq","breeze","store","observableExtensions"],function(f,d,a,g,e){var b,c;c=function(k){var h,i,j;h=f.defer();i=new a.EntityManager(k);j=i.fetchMetadata();j.done(function(l){return h.resolve({key:l.schema.entityContainer.name,manager:i,metaData:l})});j["catch"](function(){return h.reject()});return h.promise};b=void 0;return{initMe:function(i){var h;e.initMe();b=f.defer();h=f.all(d.From(i).Select(function(j){return c(j)}).ToArray());h.done(function(n){var l,m,j,k;l=[];for(j=0,k=n.length;j<k;j++){m=n[j];m.store=new g(m.metaData.schema);l.push(e.getMe().create(m.metaData.schema.entityContainer.name,m.metaData.schema))}return f.all(l).done(function(){var o;o=function(p){return d.From(n).Single(function(q){return d.From(q.metaData.schema.entityContainer.entitySet).SingleOrDefault(void 0,function(r){return r.entityType===("Self."+p)})})};return b.resolve({getStore:function(p){return o(p).store},getType:function(q){var p;m=o(q);p=d.From(m.metaData.schema.entityContainer.entitySet).Single(function(r){return r.entityType===("Self."+q)}).name;return{entityContainer:p,query:a.EntityQuery.from(p),manager:m.manager}},getCollectionType:function(q){var p;m=o(q);p=d.From(m.metaData.schema.entityType).Single(function(r){return r.name===q});return{manager:m.manager,entityType:p,collectionManager:function(s){var r,t,u,v,w,x,y;x=p.navigationProperties[s];y=x.relationship.split(".")[1];r=d.From(m.metaData.schema.association).Single(function(z){return z.name===y});w=r.referentialConstraint.dependent;v=w.propertyRef.name;u=d.From(r.end).Single(function(z){return z.role===w.role});t=d.From(m.metaData.schema.entityContainer.entitySet).Single(function(z){return z.entityType.split(".")[1]===u.type.split(".")[2]}).name;return{query:function(z){return a.EntityQuery.from(t).inlineCount().where(v,"==",z)}}}}}})})});return h["catch"](function(){return b.reject()})},getMe:function(){return b.promise}}})}).call(this);
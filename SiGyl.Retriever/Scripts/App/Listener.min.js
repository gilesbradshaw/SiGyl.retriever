(function(){define(["jquery","knockout","listenToken","linq","Q"],function(a,m,p,n,q){var g,h,i,j,k,l,o,b,c,d,e,f;f={};e={};c={};b={};d={};l=false;j=false;i=void 0;h=5000;k=function(){var r,s,t,u,v;for(r in e){s=e[r];delete e[s.key];d[s.key]=s}v=n.From(d).GroupBy(function(w){return w.Value.retriever});t=v.Where(function(w){return w.Key()}).Select(function(z){var w,x,y;x=n.From(z.source).Select(function(A){return A.Value}).ToArray();y=z.Key();w=y.retrieve(x);return w.then(function(F){var E,A,B,C,D;if(F){C=z.source;D=[];for(A=0,B=C.length;A<B;A++){E=C[A];E.Value.dataMerge(F);if(E.Value.dataReceived){D.push(E.Value.dataReceived(E.Value.dataReceived()+1))}else{D.push(void 0)}}return D}}).fail(function(A){return alert(("retrieval error "+(z.Key())+" ")+A)})}).ToArray();u=q.all(t);u.done(function(w){for(r in d){s=d[r];delete d[s.key];c[s.key]=s}if(Object.keys(e).length){return k()}else{l=false;if(i){clearTimeout(i);if(h>0){h-=100}}return i=setTimeout(function(){if(!Object.keys(e).length){if(!j){h=5000;return g()}}},h)}});return u.fail(function(w){return alert(w)})};g=(function(r){return function(){var u,v,w,y,z,A,B,s,t;j=true;for(v in c){w=c[v];delete c[w.key];b[w.key]=w}for(v in f){A=f[v];delete b[A.key];if(n.From(b).Any(function(C){return A.compare(C.Value)})){delete f[v]}}y=n.From(f).GroupBy((function(C){return C.Value.retriever}),function(C){return C.Value});u=n.From(b).Where(function(C){return !f[C.Key]}).GroupBy((function(C){return C.Value.retriever}),function(C){return C.Value});s=u.ToArray();if(y.Any()){t=y.ToArray();B=1}z=y.Select(function(C){var x;x={retriever:C.Key(),unlistens:p.getMe().getUnlistens(C,u.Where(function(D){return D.Key()===C.Key()}).SingleOrDefault(void 0,function(D){return D.Key()===C.Key()}))};return x}).Select(function(x){return x.retriever.unlisten(n.From(x.unlistens.ids).Select(function(C){return{type:C.type,ids:[{Id:0,ParameterGroups:[{Name:"",Parameters:[{Name:"id",Id:"id",Values:n.From(C.ids).Select(function(D){return{Name:"id",Value:D}}).ToArray()}]}]}]}}).ToArray(),n.From(x.unlistens.collections).Select(function(C){return{type:C.type,collections:n.From(C.ids).Select(function(D){return{collection:D.collection,ids:[{Id:0,ParameterGroups:[{Name:"",Parameters:[{Name:"id",Id:"id",Values:n.From(D.ids).Select(function(E){return{Name:"id",Value:E}}).ToArray()}]}]}]}}).ToArray()}}).ToArray())}).ToArray();return a.when.apply(a,z).done(function(){for(v in f){w=f[v];delete f[w.key]}j=false;if(Object.keys(e).length){return o.cycle()}}).fail(function(x){return alert(" ...."+x)})}})(this);o={listening:function(){return e},cycled:function(){return c},cycling:function(){return d},unlistening:function(){return f},completed:function(){return b},listen:(function(r){return function(u){var s,t,v,w,x;v=u.recycling;w=u.relistening;u.recycling=false;u.relistening=false;u.cachedCollectionRetrieveRequests=void 0;u.cachedRetrieveRequests=void 0;if(f[u.key]){delete f[u.key]}if(!e[u.key]&&(!d[u.key]||v)){if(d[u.key]){delete d[u.key]}for(t in b){x=b[t];if(!w){if(u.compare(x)){b[u.key]=u;s=true;if(!u.data()){s=false}else{if(x.data().length!==void 0){if(u.data().length!==x.data().length||n.From(u.data()).Any(function(y){return !n.From(x.data()).Any(function(z){return z.Id()===y.Id()})})){s=false}}else{if(!u.data().Id||u.data().Id()!==x.data().Id()){s=false}}}if(!s){u.data(x.data())}return o}}}if(c[u.key]){delete c[u.key]}e[u.key]=u}o.cycle();return o}})(this),unlisten:function(r){if(e[r.key]){delete e[r.key]}f[r.key]=r;o.cycle();return o},cycle:function(){if(!l&&!j){l=true;k()}return o},deleteData:function(s,r){n.From(b).Where(function(t){return t.Value.retriever===s&&t.Value.type===r.type}).Select(function(t){return t.Value.deleteData(r)}).ToArray();n.From(c).Where(function(t){return t.Value.retriever===s&&t.Value.type===r.type}).Select(function(t){return t.Value.deleteData(r)}).ToArray();return n.From(d).Where(function(t){return t.Value.retriever===s&&t.Value.type===r.type}).Select(function(t){return t.Value.queueDeleteData(r)}).ToArray()},addData:function(s,r){n.From(b).Where(function(t){return t.Value.retriever===s&&t.Value.type===r.type}).Select(function(t){return t.Value.addData(r)}).ToArray();n.From(c).Where(function(t){return t.Value.retriever===s&&t.Value.type===r.type}).Select(function(t){return t.Value.addData(r)}).ToArray();return n.From(d).Where(function(t){return t.Value.retriever===s&&t.Value.type===r.type}).Select(function(t){return t.Value.queueAddData(r)}).ToArray()}};return{getMe:function(){return o},initMe:function(){f={};e={};d={};c={};b={};l=false;j=false;if(i){return clearTimeout(i)}}}})}).call(this);
(function(){define(["knockout","Q","linq","utils","rx","knockout.rx","observableExtensions.listener"],function(f,i,g,l,k){var a,b,c,d,e,h,j;c=function(m,n){return{retrieve:function(){return{retrieved:m.observable.toKoObservable(n)}}}};a=(function(m){return function(n){return{base:function(o){f.utils.unwrapObservable(o);n.clearQuery();n.makeQuery(function(p){return p.where("Name","startsWith","N")});return this}}}})(this);b=(function(m){return function(n){return{orderBy:function(o){n.makeQuery(function(p){return p.orderBy(""+(f.utils.unwrapObservable(o)))});return this}}}})(this);f.extenders.retrieve=function(n,m){n.retrieve=function(o){m.retrieve();return{retrieved:function(){return n}}};return n};f.extenders.order=function(n,m){n.order=function(o){f.utils.unwrapObservable(o);m.makeQuery(function(p){return""+p+" from order "+(f.utils.unwrapObservable(o))});return n};return n};f.extenders.base=function(n,m){n.base=n.any=function(o){f.utils.unwrapObservable(o);m.clearQuery();m.makeQuery(function(p){return p.where("Name","startsWith","N")});return n};return n};e=function(q,s,p,o,t){var r,m,n;n=[];m=[];r=k.Observable.create(function(w){var u,v;u=void 0;v=n.reduce((function(y,x){return x(y)}),o());j.subscriber(s()).then(function(B){var x,y,z,A;y=[];z=[];x=v._toFilterFunction(t.breezeEntityType);A=t.executeQuery(v);A.then(function(C){q=p(w,q,C.storedResults,y,z);y=void 0;return z=void 0});A.fail(function(C){return alert(C)});return u=B().subscribe(function(D){var C;C=D.deleted;if(D.changed){if(!x(D.changed)){C=D.changed}else{if(y){y.push(D.changed)}else{q=p(w,q,void 0,[D.changed])}}}if(C){if(z){return z.push(C)}else{return q=p(w,q,void 0,void 0,[C])}}})});return function(){if(u){return u.dispose()}}});return{observable:r,clearQuery:function(){return n=[]},makeQuery:function(u){return n.push(u)},makeMergeFunc:function(u){return m.push(u)}}};h={testManyObservable:function(m,n){return function(){var o;o=e(f.observableArray,function(){return m},function(v,y,u,w){var x,p,q,r,s,t;for(p=0,r=y.length;p<r;p++){x=y[p];v.push(x)}if(u){t=[];for(q=0,s=u.length;q<s;q++){x=u[q];t.push(v.push(x))}return t}},function(){return"initialQuery"},d.getType(n));return{root:o.data.extend({base:{makeQuery:o.makeQuery,clearQuery:o.clearQuery},order:{makeQuery:o.makeQuery},retrieve:{retrieve:o.retrieve}})}}},rootObservable:function(m,n){return function(){var o,p;p=d.getType(n);o=e(void 0,function(){return""+n+":.:"+m},function(v,r,u,q,s){var t,w;w=r;if(u&&u.length){t=u[u.length-1]}if(q&&q.length){t=q[q.length-1]}if(t!==w){v.onNext(t)}return t},function(){var q;q=p.query();q=q.where("Id","==",m);return q},p);return $.extend({},c(o))}},manyObservable:function(n,o,m){return function(){var p,q;q=(d.getType(o)).collectionManager(m);p=e([],function(){return q.subscriptionDefinition(n)},function(A,w,z,v,x){var u,y,r,s,t;u=false;if(z){w=z;u=true}if(v){t=g.From(v).Where(function(B){return w.indexOf(B)<0}).ToArray();for(r=0,s=t.length;r<s;r++){y=t[r];w.push(y);u=true}}if(x){x.map(function(B){var C;if((C=w.indexOf(B))>=0){w.splice(w.indexOf(y),1);return u=true}})}if(u){A.onNext(w)}return w},function(){var r;return r=q.query(n.Id())},q);return $.extend({},c(p,[]),a(p),b(p))}},singleObservable:function(n,o,m){return function(){var p,q;q=(d.getType(m.name)).singleManager(o);p=e(void 0,function(){return q.subscriptionDefinition(n)},function(w,s,v,r,t){var u,x;x=s;if(v&&v.length){u=v[v.length-1]}if(r&&r.length){u=r[r.length-1]}if(x!==u){w.onNext(u)}return u},function(){var r;return r=q.query(n)},q);return $.extend({},c(p))}}};j=void 0;d=void 0;return{getMe:function(){return h},initMe:function(){var m;m=i.defer();require(["breezeEntityManagers"],function(n){return n.getMe().then(function(o){d=o;j=o;return m.resolve()})});return m.promise}}})}).call(this);
(function(){define(["knockout","Q","linq","utils","rx","breeze","knockout.rx"],function(e,i,f,n,j,a){var b,c,d,g,h,k,l,m,o;d=function(p,q){return{get:function(){return{got:p.observable.toKoObservable(q)}}}};o=(function(p){return function(q){return{where:function(s,r,t){q.makeQuery(function(u){return u.where(s,r,t)});return this}}}})(this);h=(function(p){return function(q){return{orderBy:function(r){q.makeQuery(function(s){return s.orderBy(""+(e.utils.unwrapObservable(r))+" desc")});return this}}}})(this);l=(function(p){return function(q){return{skip:function(r){q.makeQuery(function(s){return s.skip(e.utils.unwrapObservable(r))});return this}}}})(this);m=(function(p){return function(q){return{take:function(r){q.makeQuery(function(s){return s.take(e.utils.unwrapObservable(r))});return this}}}})(this);k=(function(p){return function(q){return{selectMany:function(r){var s;q.buildQuery();s=q.observable.selectMany(function(t){return j.Observable.create(function(u){return u.onNext(g.manyObservable(t,q.typeManager.entityType.name,r)())})});return{got:s.toKoObservable()}}}}})(this);b=function(u,x,t,s,y){var r,v,w,p,q;q=[];p=[];v=void 0;w=j.Observable.create(function(B){var z,A,C;z=void 0;r.buildQuery();A=v._toFilterFunction(y.breezeEntityType);C=v._toOrderByComparer(y.breezeEntityType);c.subscriber(x()).then(function(G){var D,E,F;E=[];F=[];D=function(){var H;H=y.executeQuery(v);H.then(function(J){var I;I=t(u,J.storedResults,E,F);u=I.data;B.onNext(u);E=void 0;return F=void 0});return H.fail(function(I){return alert(I)})};D();return z=j.Observable.merge(G.map(function(H){return H()})).subscribe(function(N){var J,K,L,M,H,I;K=N.deleted;if(N.changed){if(!A(N.changed)){K=N.changed}else{if(E){E.push(N.changed)}else{J=t(u,void 0,[N.changed]);u=J.data}}}if(K){if(F){F.push(K)}else{J=t(u,void 0,void 0,[K]);u=J.data}}if(J){if(u instanceof Array){for(L=H=0,I=u.length-2;0<=I?H<=I:H>=I;L=0<=I?++H:--H){if(u.length>1&&C&&C(u[L],u[L+1])>0){M=true;u.sort(C);L=u.length-2}}if(v.skipCount&&u.indexOf(N.changed)===0){D();return}else{if(v.takeCount){if(u.length>v.takeCount){u.splice(u.length-1,1)}}}}}if(J.changed||M){return B.onNext(u)}})});return function(){if(z){return z.dispose()}}});return r={typeManager:y,observable:w,buildQuery:function(){v=q.reduce((function(A,z){return z(A)}),s());return q=[]},makeQuery:function(z){return q.push(z)},makeMergeFunc:function(z){return p.push(z)}}};g={testManyObservable:function(p,q){return function(){var r;r=b(e.observableArray,function(){return p},function(y,B,x,z){var A,s,t,u,v,w;for(s=0,u=B.length;s<u;s++){A=B[s];y.push(A)}if(x){w=[];for(t=0,v=x.length;t<v;t++){A=x[t];w.push(y.push(A))}return w}},function(){return"initialQuery"},c.getType(q));return{root:r.data.extend({base:{makeQuery:r.makeQuery,clearQuery:r.clearQuery},order:{makeQuery:r.makeQuery},get:{get:r.get}})}}},rootObservable:function(p,q){return function(){var r,s;s=c.getType(q);r=b(void 0,function(){return[""+q+":.:"+p]},function(u,x,t,v){var w,y;y=u;if(x&&x.length){w=x[x.length-1]}if(t&&t.length){w=t[t.length-1]}if(w!==y){return{changed:true,data:w}}else{return{changed:false,data:w}}},function(){var t;t=s.query.where("Id","==",p);return t},s);return $.extend({},d(r))}},interModelObservable:function(p,r,q){return function(){var s,t;t=(c.getType(r)).interModelManager(q);s=b(void 0,function(){return[t.subscriptionDefinition(p)]},function(v,y,u,w){var x,z;z=v;if(y&&y.length){x=y[y.length-1]}if(u&&u.length){x=u[u.length-1]}if(z!==x){return{changed:true,data:x}}else{return{changed:false,data:x}}},function(){var u;return u=t.query.where(t.predicate(p))},t);return $.extend({},d(s))}},manyObservable:function(q,r,p){return function(){var s,t;t=(c.getType(r)).collectionManager(p);s=b([],function(){return q.map(function(u){return t.subscriptionDefinition(u)})},function(z,C,y,A){var x,B,u,v,w;x=false;if(C){z=C;x=true}if(y){w=f.From(y).Where(function(D){return z.indexOf(D)<0}).ToArray();for(u=0,v=w.length;u<v;u++){B=w[u];z.push(B);x=true}}if(A){A.map(function(D){var E;if((E=f.From(z).SingleOrDefault(void 0,function(F){return F.Id()===D.Id()}))){z.splice(z.indexOf(E),1);return x=true}})}return{changed:x,data:z}},function(){var u;return u=t.query.where(a.Predicate.or(q.map(function(v){return t.predicate(v)})))},t);return $.extend({observable:s.observable},d(s,[]),h(s),l(s),m(s),o(s),k(s))}},singleObservable:function(q,r,p){return function(){var s,t;t=(c.getType(p.name)).singleManager(r);s=b(void 0,function(){return[t.subscriptionDefinition(q)]},function(v,y,u,w){var x,z;z=v;if(y&&y.length){x=y[y.length-1]}if(u&&u.length){x=u[u.length-1]}if(z!==x){return{changed:true,data:x}}else{return{changed:false,data:x}}},function(){var u;return u=t.query.where(t.predicate(q))},t);return $.extend({},d(s))}}};c=void 0;return{getMe:function(){return g},initMe:function(q){var p;p=i.defer();require(["breezeEntityManagers"],function(r){return r.initMe(q).then(function(){return r.getMe().then(function(s){c=s;return p.resolve()})})});return p.promise}}})}).call(this);
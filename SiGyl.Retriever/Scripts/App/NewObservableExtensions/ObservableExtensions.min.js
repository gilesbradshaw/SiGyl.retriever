(function(){define(["knockout","Q","linq","utils","rx","knockout.rx","observableExtensions.listener"],function(e,i,f,m,j){var a,b,c,d,g,h,k,l;d=function(n,o){return{get:function(){n.buildQuery();return{got:n.observable.toKoObservable(o)}}}};a=(function(n){return function(o){return{base:function(p){e.utils.unwrapObservable(p);o.makeQuery(function(q){return q.where("Name","startsWith","N")});return this}}}})(this);h=(function(n){return function(o){return{orderBy:function(p){o.makeQuery(function(q){return q.orderBy(""+(e.utils.unwrapObservable(p))+" desc")});return this}}}})(this);k=(function(n){return function(o){return{skip:function(p){o.makeQuery(function(q){return q.skip(e.utils.unwrapObservable(p))});return this}}}})(this);l=(function(n){return function(o){return{take:function(p){o.makeQuery(function(q){return q.take(e.utils.unwrapObservable(p))});return this}}}})(this);e.extenders.get=function(o,n){o.get=function(p){n.get();return{got:function(){return o}}};return o};e.extenders.order=function(o,n){o.order=function(p){e.utils.unwrapObservable(p);n.makeQuery(function(q){return""+q+" from order "+(e.utils.unwrapObservable(p))});return o};return o};e.extenders.base=function(o,n){o.base=o.any=function(p){e.utils.unwrapObservable(p);n.clearQuery();n.makeQuery(function(q){return q.where("Name","startsWith","N")});return o};return o};b=function(r,u,q,p,v){var s,t,n,o;o=[];n=[];s=void 0;t=j.Observable.create(function(y){var w,x,z;w=void 0;x=s._toFilterFunction(v.breezeEntityType);z=s._toOrderByComparer(v.breezeEntityType);c.subscriber(u()).then(function(D){var A,B,C;B=[];C=[];A=function(){var E;E=v.executeQuery(s);E.then(function(G){var F;F=q(r,G.storedResults,B,C);r=F.data;y.onNext(r);B=void 0;return C=void 0});return E.fail(function(F){return alert(F)})};A();return w=D().subscribe(function(K){var G,H,I,J,E,F;H=K.deleted;if(K.changed){if(!x(K.changed)){H=K.changed}else{if(B){B.push(K.changed)}else{G=q(r,void 0,[K.changed]);r=G.data}}}if(H){if(C){C.push(H)}else{G=q(r,void 0,void 0,[H]);r=G.data}}if(G){if(r instanceof Array){for(I=E=0,F=r.length-2;0<=F?E<=F:E>=F;I=0<=F?++E:--E){if(z(r[I],r[I+1])>0){J=true;r.sort(z);I=r.length-2}}if(s.skipCount&&r.indexOf(K.changed)===0){A();return}else{if(s.takeCount){if(r.length>s.takeCount){r.splice(r.length-1,1)}}}}}if(G.changed||J){return y.onNext(r)}})});return function(){if(w){return w.dispose()}}});return{observable:t,buildQuery:function(){s=o.reduce((function(x,w){return w(x)}),p());return o=[]},makeQuery:function(w){return o.push(w)},makeMergeFunc:function(w){return n.push(w)}}};g={testManyObservable:function(n,o){return function(){var p;p=b(e.observableArray,function(){return n},function(w,z,v,x){var y,q,r,s,t,u;for(q=0,s=z.length;q<s;q++){y=z[q];w.push(y)}if(v){u=[];for(r=0,t=v.length;r<t;r++){y=v[r];u.push(w.push(y))}return u}},function(){return"initialQuery"},c.getType(o));return{root:p.data.extend({base:{makeQuery:p.makeQuery,clearQuery:p.clearQuery},order:{makeQuery:p.makeQuery},get:{get:p.get}})}}},rootObservable:function(n,o){return function(){var p,q;q=c.getType(o);p=b(void 0,function(){return""+o+":.:"+n},function(s,v,r,t){var u,w;w=s;if(v&&v.length){u=v[v.length-1]}if(r&&r.length){u=r[r.length-1]}if(u!==w){return{changed:true,data:u}}else{return{changed:false,data:u}}},function(){var r;r=q.query();r=r.where("Id","==",n);return r},q);return $.extend({},d(p))}},manyObservable:function(o,p,n){return function(){var q,r;r=(c.getType(p)).collectionManager(n);q=b([],function(){return r.subscriptionDefinition(o)},function(x,A,w,y){var v,z,s,t,u;v=false;if(A){x=A;v=true}if(w){u=f.From(w).Where(function(B){return x.indexOf(B)<0}).ToArray();for(s=0,t=u.length;s<t;s++){z=u[s];x.push(z);v=true}}if(y){y.map(function(B){var C;if((C=x.indexOf(B))>=0){x.splice(x.indexOf(z),1);return v=true}})}return{changed:v,data:x}},function(){var s;return s=r.query(o.Id())},r);return $.extend({},d(q,[]),a(q),h(q),k(q),l(q))}},singleObservable:function(o,p,n){return function(){var q,r;r=(c.getType(n.name)).singleManager(p);q=b(void 0,function(){return r.subscriptionDefinition(o)},function(t,w,s,u){var v,x;x=t;if(w&&w.length){v=w[w.length-1]}if(s&&s.length){v=s[s.length-1]}if(x!==v){return{changed:true,data:v}}else{return{changed:false,data:v}}},function(){var s;return s=r.query(o)},r);return $.extend({},d(q))}}};c=void 0;return{getMe:function(){return g},initMe:function(){var n;n=i.defer();require(["breezeEntityManagers"],function(o){return o.getMe().then(function(p){c=p;return n.resolve()})});return n.promise}}})}).call(this);
(function(){define(["Q","linq","breezeretriever","listener","source","observableExtensions","rx.binding"],function(e,b,a,c,j,d,i){var g,f,h;h=0;g={};f={subscriber:function(l){var k;if(!g[l]){k=i.Observable.create(function(m){g[l].observer=m;return function(){delete g[l];return j.getMe().invoke("NewLeave",l)}});g[l]={subject:k,share:k.share(),subscriptionDeferred:e.defer()};j.getMe().invoke("NewJoin",l).done(function(){if(g[l]){return g[l].subscriptionDeferred.resolve(function(){return g[l].share})}}).fail(function(m){if(g[l]){return g[l].subscriptionDeferred.reject(m)}})}return g[l].subscriptionDeferred.promise},retrieve:function(p){var k,l,m,n,o;o=h++;l=e.defer();n=b.From(p).Aggregate([],function(q,r){if(r.retrieveRequestMerge){return r.retrieveRequestMerge(q)}else{return q}})||[];k=b.From(p).Aggregate([],function(q,r){if(r.collectionRetrieveRequestMerge){return r.collectionRetrieveRequestMerge(q)}else{return q}})||[];m=j.getMe().invoke("join",o++,n,k);m.fail(function(q){return l.reject(q)});m.done(function(r){var q;q=e.all([a.getMe().get(n),a.getMe().getCollection(k)]);q["catch"](function(s){return l.rejectError});return q.done(function(A){var y,z,B,s,t,u,v,w,x;B=[];w=A[0];for(s=0,u=w.length;s<u;s++){y=w[s];z=b.From(A[1]).SingleOrDefault(void 0,function(C){return C.Type===y.Type});if(z){y.Ids=y.Ids||z.Ids;y.Collections=y.Collections||z.Collections}B.push(y)}x=A[1];for(t=0,v=x.length;t<v;t++){y=x[t];if(!b.From(A[0]).Any(function(C){return C.Type===y.Type})){B.push(y)}}return l.resolve(B)})});return l.promise},unlisten:function(n,k){var l,m;l=e.defer();m=j.getMe().invoke("leave",n,k);m.done(function(o){return l.resolve(o)});m.fail(function(o){return l.reject(o)});m["finally"](function(){});return l.promise}};return{getMe:function(){return f},initMe:function(k){return a.initMe(k).then(function(){h=0;return j.initMe().then(function(){j.getMe().on("change",function(m,n,l){return a.getMe().changeData(m,n,l).done(function(o){if(g[""+n+":.:"+m]){g[""+n+":.:"+m].observer.onNext(o.value)}if(o){c.getMe().addData(f,o);return c.getMe().cycle()}})});return j.getMe().on("delete",function(m,n,l){return a.getMe().deleteData(m,n,l).done(function(o){if(o){c.getMe().deleteData(f,o)}return c.getMe().cycle()})})})})}}})}).call(this);
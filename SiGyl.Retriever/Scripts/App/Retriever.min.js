(function(){define(["Q","linq","breezeretriever","listener","source","observableExtensions"],function(e,b,a,c,h,d){var f,g;g=0;f={retrieve:function(o){var j,k,l,m,n;n=g++;k=e.defer();m=b.From(o).Aggregate([],function(i,p){if(p.retrieveRequestMerge){return p.retrieveRequestMerge(i)}else{return i}})||[];j=b.From(o).Aggregate([],function(i,p){if(p.collectionRetrieveRequestMerge){return p.collectionRetrieveRequestMerge(i)}else{return i}})||[];l=h.getMe().invoke("join",n++,m,j);l.fail(function(i){return k.reject(i)});l.done(function(p){var i;i=e.all([a.getMe().get(m),a.getMe().getCollection(j)]);i["catch"](function(q){return k.rejectError});return i.done(function(z){var x,y,A,q,s,t,u,v,w;A=[];v=z[0];for(q=0,t=v.length;q<t;q++){x=v[q];y=b.From(z[1]).SingleOrDefault(void 0,function(r){return r.Type===x.Type});if(y){x.Ids=x.Ids||y.Ids;x.Collections=x.Collections||y.Collections}A.push(x)}w=z[1];for(s=0,u=w.length;s<u;s++){x=w[s];if(!b.From(z[0]).Any(function(r){return r.Type===x.Type})){A.push(x)}}return k.resolve(A)})});return k.promise},unlisten:function(m,j){var k,l;k=e.defer();l=h.getMe().invoke("leave",m,j);l.done(function(i){return k.resolve(i)});l.fail(function(i){return k.reject(i)});l["finally"](function(){});return k.promise}};return{getMe:function(){return f},initMe:function(i){return a.initMe(i).then(function(){g=0;return h.initMe().then(function(){h.getMe().on("change",function(k,l,j){return a.getMe().changeData(k,l,j).done(function(m){if(m){c.getMe().addData(f,m);return c.getMe().cycle()}})});return h.getMe().on("delete",function(k,l,j){return a.getMe().deleteData(k,l,j).done(function(m){if(m){c.getMe().deleteData(f,m)}return c.getMe().cycle()})})})})}}})}).call(this);
(function(){define(["q","linq"],function(b,a){var c,d;d=0;return c=(function(){function e(h,i,f){var g;this.retrieve=function(o){var j,k,l,m,n;n=d++;k=b.defer();m=a.From(o).Aggregate([],function(p,q){if(q.retrieveRequestMerge){return q.retrieveRequestMerge(p)}else{return p}})||[];j=a.From(o).Aggregate([],function(p,q){if(q.collectionRetrieveRequestMerge){return q.collectionRetrieveRequestMerge(p)}else{return p}})||[];l=h.invoke("join",n++,m,j);l["catch"](function(p){return k.reject(p)});l.done(function(p){return k.resolve(i.mergeData(p))});return k.promise};this.unlisten=function(m,j){var k,l;k=b.defer();l=h.invoke("leave",m,j);l.done(function(n){return k.resolve(n)});l["catch"](function(n){return k.reject(n)});l["finally"](function(){});return k.promise};g=0;h.on("change",(function(j){return function(m,n,l){var k;if(k=i.changeData(m,n,l)){f.addData(j,k);return f.cycle()}}})(this));h.on("delete",(function(j){return function(l,n,k){var m;m=i.deleteData(l,n,k);if(m){f.deleteData(j,m);return f.cycle()}}})(this))}return e})()})}).call(this);
(function(){define(["jquery","knockout","Q","listenToken","utils","breeze","linq","observableExtensions.listener","observableExtensions.base","observableExtensions.order","observableExtensions.filter","observableExtensions.page","observableExtensions.title","observableExtensions.selectMany","observableExtensions.selectSingle","observableExtensions.select","observableExtensions.mixinTo"],function(a,c,g,e,h,b,d){var f;f=f=(function(){function i(k,p,m){var j,l,n,o;n=0;j=(function(q){return function(){var t,r,s;s=void 0;r=void 0;return t={getListenToken:function(u){var v;v=s;s=function(w){if(v){return u(v(w))}else{return u(w)}};return t},entityType:function(u){r=u;return t},extend:function(){r;return c.observable().extend({listener:{subscribeActions:function(){return{onSubscribe:function(){throw"Illegal attempt to subscribe to unextended observable"}}}},base:{getListenToken:function(u){return s(u)},listen:function(u){return m.listen(u)},cycle:function(){return m.cycle()},unlisten:function(u){return m.unlisten(u)},extend:function(){return{mixin:{},mixinTo:{},page:{listener:m},order:{entityType:r},filter:{entityType:r},title:{},idPush:{},extendListenToken:{},selectMany:{listener:m,observableExtensions:i,manyObservable:q.manyObservable,entityType:r},selectSingle:{listener:m,observableExtensions:i,manySingleObservable:q.manySingleObservable,conceptualModel:k,entityType:r}}}}})}}}})(this);this.manyObservable=(function(q){return function(s,u,r,t){return j().entityType(h.getMe().getDependent(t,r).entityType).getListenToken(function(x){var v,w;w="Collection:"+u+":"+r+":"+(n++);v=new (e.getMe())(p,x||c.observableArray());v.type=""+u+"."+r;v.key=w;v.canAddData=(function(y){return function(z,A){if(z.value){if(z.type===(""+u+"."+r)){if(s.Id()===z.value[h.getMe().getDependent(t,r).id()]()){return true}}}}})(this);v.addData=(function(y){return function(z){var A,B;A=v.data().indexOf(z.value)!==-1;B=v.data();if(!A){B=B.concat([z.value])}if(v.canAddData(z,B)){if(!A){if(v.mixin){B[B.indexOf(z.value)]=v.mixin(z.value)}return v.data(B)}}else{if(A){if(B.indexOf(z.value)>-1){B.splice(B.indexOf(z.value),1)}return v.data(B)}}}})(this);v.deleteData=(function(y){return function(z){if(z.value){if(z.type===(""+u+"."+r)){if(s.Id()===z.value[h.getMe().getDependent(t,r).id()]()){return v.data.remove(z.value)}}}}})(this);v.getProcessMetaData(function(y){return v.metaData=y});v.getDataMerge(function(A){var B,C,y,z;if(z=d.From(A).SingleOrDefault(void 0,function(D){return D.Type===u})){if(y=d.From(z.Collections).SingleOrDefault(void 0,function(D){return D.Collection===r})){if(B=d.From(y.Ids).SingleOrDefault(void 0,function(D){return D.Key===s.Id()})){if(C=d.From(B.ParameterGroups).SingleOrDefault(void 0,function(E){var D;return(E.Name===(D=E.Name)&&D===w)})){v.data(c.utils.arrayMap(C.Collection.data,function(D){if(v.mixin){return v.mixin(D)}else{return D}}));return v.processMetaData(C.Collection.metaData)}}}}});v.getCollectionRetrieveRequest(function(B){var z,A,C,y;C=d.From(B).SingleOrDefault(void 0,function(D){return D.type===u});if(!C){C={collections:[],type:u};B.push(C)}y=d.From(C.collections).SingleOrDefault(void 0,function(D){return D.collection===r});if(!y){y={collection:r,ids:[]};C.collections.push(y)}z=d.From(y.ids).SingleOrDefault(void 0,function(D){return D.Id===s.Id()});if(!z){z={Id:s.Id(),IdProperty:"Id",ParameterGroups:[]};y.ids.push(z)}A=d.From(z.ParameterGroups).SingleOrDefault(void 0,function(D){return D.Name===w});if(!A){A={Name:w,Parameters:[]}}z.ParameterGroups.push(A);return A.Parameters});return v.modifyCollectionRetrieveRequest(function(y){return y.push({Name:"id",Id:"id",Values:[{Name:"id",Value:s.Id()}]})})}).extend()}})(this);this.manySingleObservable=(function(q){return function(r){return j().entityType(function(){return r}).getListenToken(function(u){var s,t;t="ManySingle:"+r.name+":"+(n++);s=new (e.getMe())(p,u||c.observableArray());s.type=""+r.name;s.key=t;s.getDataMerge(function(w){var x,y,v;if(v=d.From(w).SingleOrDefault(void 0,function(z){return z.Type===r.name})){if(x=d.From(v.Ids).SingleOrDefault(void 0,function(z){return z.Key==="0"})){if(y=d.From(x.ParameterGroups).SingleOrDefault(void 0,function(A){var z;return(A.Name===(z=A.Name)&&z===t)})){return s.data(c.utils.arrayMap(y.Value,function(z){if(s._mixinTo){return s._mixinTo(z)}else{return z}}))}}}});s.getRetrieveRequest(function(x){var v,w,y;y=d.From(x).SingleOrDefault(void 0,function(z){return z.type===r.name});if(!y){y={ids:[],type:r.name};x.push(y)}v=d.From(y.ids).SingleOrDefault(void 0,function(z){return z.Id===false});if(!v){v={Id:0,IdProperty:"Id",ParameterGroups:[]};y.ids.push(v)}w=d.From(v.ParameterGroups).SingleOrDefault(void 0,function(z){return z.Name===t});if(!w){w={Name:t,Parameters:[]}}v.ParameterGroups.push(w);return w.Parameters});return s.modifyRetrieveRequest(function(v){return v.push({Name:"id",Id:"id"})})}).extend()}})(this);o=(function(q){return function(z,t,w,x,r,s,v){var u,y;u=void 0;y=c.observable().extend({listener:{subscribeActions:function(){return{onSubscribe:function(){throw"Illegal attempt to subscribe to unextended observable"}}}},base:{cycle:function(){return m.cycle()},getListenToken:function(D){var A,B,C;C=""+v+":"+r.name+":"+w+":"+(n++);A=void 0;B=new (e.getMe())(z,c.observable().extend({listener:{subscribeActions:function(){var E;E=void 0;return{subscribePing:function(){},disposePing:function(){},onSubscribe:function(){var F;if(t.peek()){A=t.peek()}F=function(G){if(u&&G!==u){A=u;m.unlisten(a.extend({},B))}C=""+v+":"+r.name+":"+w+":"+(n++);B.key=C;B.relistening=true;if(G){m.listen(B)}else{B.data(void 0)}u=G;return m.cycle()};u=t.peek();if(u){F(u)}return E=t.subscribe(F)},onDispose:function(){E.dispose();if(t.peek()){m.unlisten(B);return m.cycle()}}}}}}));B.getDataMerge(function(E){var F,G,H;if(t.peek()){if(H=d.From(E).SingleOrDefault(void 0,function(I){return I.Type===x})){if(F=d.From(H.Ids).SingleOrDefault(void 0,function(I){return I.Key===t.peek()})){if(G=d.From(F.ParameterGroups).SingleOrDefault(void 0,function(J){var I;return(J.Name===(I=J.Name)&&I===C)})){return B.data(d.From(G.Value).SingleOrDefault(void 0))}}}}});B.getRetrieveRequest(function(G){var E,F,H;if(t.peek()){H=d.From(G).SingleOrDefault(void 0,function(I){return I.type===x});if(!H){H={ids:[],type:x};G.push(H)}E=d.From(H.ids).SingleOrDefault(void 0,function(I){return I.Id===t.peek()});if(!E){E={Id:t.peek(),ParameterGroups:[]};H.ids.push(E)}F=d.From(E.ParameterGroups).SingleOrDefault(void 0,function(I){return I.Name===C});if(!F){F={Name:C,Parameters:[]}}E.ParameterGroups.push(F);return F.Parameters}});B.modifyRetrieveRequest(function(E){if(t()){return E.push({Name:"id",Id:"id",Values:[{Name:"id",Value:t.peek()}]})}});return B},listen:function(A){return m.listen(A)},unlisten:function(A){return m.unlisten(A)},extend:function(){return{title:{},extendListenToken:{},select:{listener:m,observableExtensions:i,manyObservable:q.manyObservable,entityType:s}}}}});return y.base()()}})(this);this.selfObservable=(function(q){return function(r,u){var s,t;t=r.Id;s=function(){return k.entities[u]};return o(p,t,".",u,k.entities[u],s,"Self")}})(this);this.singleObservable=(function(q){return function(r,v,s){var t,u;u=h.getMe().getPrincipal(s,v);t=r[u.id()];return o(p,t,v,u.type(),s,u.entityType,"Single")}})(this);this.flexibleRelationObservable=(function(q){return function(r,w,s){var t,u,v,x;v=d.From(s.flexibleRelations).Single(function(y){return y.name===w});u=r[v.idProperty];x=r[v.relatedTypeProperty]();t=function(){return k.entities[v.relatedTypeProperty]};return o(p,u,w,x,s,t,"Flexible")}})(this);l={};this.interModelRelationObservable=(function(q){return function(s,x,t){var u,v,w,y,r;w=d.From(t.interModelRelations).Single(function(z){return z.name===x});l[r=w.model]||(l[r]=new b.EntityManager("breeze/"+w.model));v=c.observable().extend({listener:{subscribeActions:function(){return{onSubscribe:function(){var z;if(w.foreignKey!=="Id"){z=b.EntityQuery.from(w.collection).where(w.foreignKey,"==",s[w.key]()).select("Id");return l[w.model].executeQuery(z).then(function(A){return v(A.results[0].Id)})}else{return v(s[w.key]())}},disposePing:function(){},subscribePing:function(){},onDispose:function(){}}}}});y=x;u=function(){return t.model.models[w.model].entities[x]};return o(p,v,x,y,t,u,"InterModel")}})(this);this.rootObservable=(function(q){return function(r,u,t){var s;s=c.observable().extend({listener:{subscribeActions:function(){return{onSubscribe:function(){throw"Illegal attempt to subscribe to unextended observable"}}}},base:{filter:function(){return i.filter},getListenToken:function(x){var v,w;w="Root:"+u+":"+(n++);v=new (e.getMe())(p,x||c.observableArray());v.key=w;v.getDataMerge(function(A){var B,y,z;if(z=d.From(A).SingleOrDefault(void 0,function(C){return C.Type===u})){if(y=d.From(z.Ids).SingleOrDefault(void 0,function(C){return C.Key===r})){if(B=d.From(y.ParameterGroups).SingleOrDefault(void 0,function(D){var C;return(D.Name===(C=D.Name)&&C===w)})){if(typeof B.Value!=="string"){if(!t){return v.data(c.utils.arrayMap(B.Value,function(C){if(v.mixin){return v.mixin(C)}else{return C}}))}else{A=d.From(B.Value).SingleOrDefault(void 0);if(A&&v.mixin){A=v.mixin(A)}return v.data(A)}}}}}});v.getRetrieveRequest(function(A){var y,z,B;B=d.From(A).SingleOrDefault(void 0,function(C){return C.type===u});if(!B){B={ids:[],type:u};A.push(B)}y=d.From(B.ids).SingleOrDefault(void 0,function(C){return C.Id===r});if(!y){y={Id:r,ParameterGroups:[]};B.ids.push(y)}z=d.From(y.ParameterGroups).SingleOrDefault(void 0,function(C){return C.Name===w});if(!z){z={Name:w,Parameters:[]}}y.ParameterGroups.push(z);return z.Parameters});v.modifyRetrieveRequest(function(y){return y.push({Name:"id",Id:"id",Values:[{Name:"id",Value:r}]})});return v},listen:function(v){return m.listen(v)},unlisten:function(v){return m.unlisten(v)},extend:function(){return{mixin:{},page:{listener:m},order:{entityType:function(){return k.entities[u]}},filter:{entityType:function(){return k.entities[u]}},title:{},extendListenToken:{},selectMany:{listener:m,manyObservable:q.manyObservable,entityType:function(){return k.entities[u]}}}}}});return s.base()()}})(this)}i.create=function(k,l){var j;j=g.defer();require(["retriever","listener"],function(n,m){i.modelExtensions[k]=new i(l,n.getMe(),m.getMe());return j.resolve()});return j.promise};return i})();return{getMe:function(){return f},initMe:function(){f.modelExtensions={};return g()}}})}).call(this);
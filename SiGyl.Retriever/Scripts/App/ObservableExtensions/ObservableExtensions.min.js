(function(){define(["jquery","knockout","Q","listenToken","breeze","linq","observableExtensions.listener","observableExtensions.base","observableExtensions.order","observableExtensions.filter","observableExtensions.page","observableExtensions.title","observableExtensions.selectMany","observableExtensions.selectSingle","observableExtensions.select","observableExtensions.mixinTo"],function(a,c,g,e,b,d){var f;f=f=(function(){function h(j,o,l){var i,k,m,n;m=0;i=(function(p){return function(){var s,q,r;r=void 0;q=void 0;return s={getListenToken:function(t){var u;u=r;r=function(v){if(u){return t(u(v))}else{return t(v)}};return s},entityType:function(t){q=t;return s},extend:function(){q;return c.observable().extend({listener:{subscribeActions:function(){return{onSubscribe:function(){throw"Illegal attempt to subscribe to unextended observable"}}}},base:{getListenToken:function(t){return r(t)},listen:function(t){return l.listen(t)},cycle:function(){return l.cycle()},unlisten:function(t){return l.unlisten(t)},extend:function(){return{mixin:{},mixinTo:{},page:{listener:l},order:{entityType:q},filter:{entityType:q},title:{},idPush:{},extendListenToken:{},selectMany:{listener:l,observableExtensions:h,manyObservable:p.manyObservable,entityType:q},selectSingle:{listener:l,observableExtensions:h,manySingleObservable:p.manySingleObservable,conceptualModel:j,entityType:q}}}}})}}}})(this);this.manyObservable=(function(p){return function(r,t,q,s){return i().entityType(function(){return j.entities[d.From(s.navigationProperties).Single(function(u){return u.name===q}).to.type]}).getListenToken(function(w){var u,v;v="Collection:"+t+":"+q+":"+(m++);u=new (e.getMe())(o,w||c.observableArray());u.type=""+t+"."+q;u.key=v;u.canAddData=(function(x){return function(y,z){if(y.value){if(y.type===(""+t+"."+q)){if(r.Id()===y.value[d.From(s.navigationProperties).Single(function(A){return A.name===q}).to.referentialConstraints[0].to[0]]()){return true}}}}})(this);u.addData=(function(x){return function(y){var z,A;z=u.data().indexOf(y.value)!==-1;A=u.data();if(!z){A=A.concat([y.value])}if(u.canAddData(y,A)){if(!z){if(u.mixin){A[A.indexOf(y.value)]=u.mixin(y.value)}return u.data(A)}}else{if(z){if(A.indexOf(y.value)>-1){A.splice(A.indexOf(y.value),1)}return u.data(A)}}}})(this);u.deleteData=(function(x){return function(y){if(y.value){if(y.type===(""+t+"."+q)){if(r.Id()===y.value[d.From(s.navigationProperties).Single(function(z){return z.name===q}).to.referentialConstraints[0].to[0]]()){return u.data.remove(y.value)}}}}})(this);u.getProcessMetaData(function(x){return u.metaData=x});u.getDataMerge(function(z){var A,B,x,y;if(y=d.From(z).SingleOrDefault(void 0,function(C){return C.Type===t})){if(x=d.From(y.Collections).SingleOrDefault(void 0,function(C){return C.Collection===q})){if(A=d.From(x.Ids).SingleOrDefault(void 0,function(C){return C.Key===r.Id()})){if(B=d.From(A.ParameterGroups).SingleOrDefault(void 0,function(D){var C;return(D.Name===(C=D.Name)&&C===v)})){u.data(c.utils.arrayMap(B.Collection.data,function(C){if(u.mixin){return u.mixin(C)}else{return C}}));return u.processMetaData(B.Collection.metaData)}}}}});u.getCollectionRetrieveRequest(function(A){var y,z,B,x;B=d.From(A).SingleOrDefault(void 0,function(C){return C.type===t});if(!B){B={collections:[],type:t};A.push(B)}x=d.From(B.collections).SingleOrDefault(void 0,function(C){return C.collection===q});if(!x){x={collection:q,ids:[]};B.collections.push(x)}y=d.From(x.ids).SingleOrDefault(void 0,function(C){return C.Id===r.Id()});if(!y){y={Id:r.Id(),IdProperty:"Id",ParameterGroups:[]};x.ids.push(y)}z=d.From(y.ParameterGroups).SingleOrDefault(void 0,function(C){return C.Name===v});if(!z){z={Name:v,Parameters:[]}}y.ParameterGroups.push(z);return z.Parameters});return u.modifyCollectionRetrieveRequest(function(x){return x.push({Name:"id",Id:"id",Values:[{Name:"id",Value:r.Id()}]})})}).extend()}})(this);this.manySingleObservable=(function(p){return function(q){return i().entityType(function(){return q}).getListenToken(function(t){var r,s;s="ManySingle:"+q.name+":"+(m++);r=new (e.getMe())(o,t||c.observableArray());r.type=""+q.name;r.key=s;r.getDataMerge(function(v){var w,x,u;if(u=d.From(v).SingleOrDefault(void 0,function(y){return y.Type===q.name})){if(w=d.From(u.Ids).SingleOrDefault(void 0,function(y){return y.Key==="0"})){if(x=d.From(w.ParameterGroups).SingleOrDefault(void 0,function(z){var y;return(z.Name===(y=z.Name)&&y===s)})){return r.data(c.utils.arrayMap(x.Value,function(y){if(r._mixinTo){return r._mixinTo(y)}else{return y}}))}}}});r.getRetrieveRequest(function(w){var u,v,x;x=d.From(w).SingleOrDefault(void 0,function(y){return y.type===q.name});if(!x){x={ids:[],type:q.name};w.push(x)}u=d.From(x.ids).SingleOrDefault(void 0,function(y){return y.Id===false});if(!u){u={Id:0,IdProperty:"Id",ParameterGroups:[]};x.ids.push(u)}v=d.From(u.ParameterGroups).SingleOrDefault(void 0,function(y){return y.Name===s});if(!v){v={Name:s,Parameters:[]}}u.ParameterGroups.push(v);return v.Parameters});return r.modifyRetrieveRequest(function(u){return u.push({Name:"id",Id:"id"})})}).extend()}})(this);n=(function(p){return function(y,s,v,w,q,r,u){var t,x;t=void 0;x=c.observable().extend({listener:{subscribeActions:function(){return{onSubscribe:function(){throw"Illegal attempt to subscribe to unextended observable"}}}},base:{cycle:function(){return l.cycle()},getListenToken:function(C){var z,A,B;B=""+u+":"+q.name+":"+v+":"+(m++);z=void 0;A=new (e.getMe())(y,c.observable().extend({listener:{subscribeActions:function(){var D;D=void 0;return{subscribePing:function(){},disposePing:function(){},onSubscribe:function(){var E;if(s.peek()){z=s.peek()}E=function(F){if(t&&F!==t){z=t;l.unlisten(a.extend({},A))}B=""+u+":"+q.name+":"+v+":"+(m++);A.key=B;A.relistening=true;if(F){l.listen(A)}else{A.data(void 0)}t=F;return l.cycle()};t=s.peek();if(t){E(t)}return D=s.subscribe(E)},onDispose:function(){D.dispose();if(s.peek()){l.unlisten(A);return l.cycle()}}}}}}));A.getDataMerge(function(D){var E,F,G;if(s.peek()){if(G=d.From(D).SingleOrDefault(void 0,function(H){return H.Type===w})){if(E=d.From(G.Ids).SingleOrDefault(void 0,function(H){return H.Key===s.peek()})){if(F=d.From(E.ParameterGroups).SingleOrDefault(void 0,function(I){var H;return(I.Name===(H=I.Name)&&H===B)})){return A.data(d.From(F.Value).SingleOrDefault(void 0))}}}}});A.getRetrieveRequest(function(F){var D,E,G;if(s.peek()){G=d.From(F).SingleOrDefault(void 0,function(H){return H.type===w});if(!G){G={ids:[],type:w};F.push(G)}D=d.From(G.ids).SingleOrDefault(void 0,function(H){return H.Id===s.peek()});if(!D){D={Id:s.peek(),ParameterGroups:[]};G.ids.push(D)}E=d.From(D.ParameterGroups).SingleOrDefault(void 0,function(H){return H.Name===B});if(!E){E={Name:B,Parameters:[]}}D.ParameterGroups.push(E);return E.Parameters}});return A.modifyRetrieveRequest(function(D){if(s()){return D.push({Name:"id",Id:"id",Values:[{Name:"id",Value:s.peek()}]})}})},listen:function(z){return l.listen(z)},unlisten:function(z){return l.unlisten(z)},extend:function(){return{title:{},extendListenToken:{},select:{listener:l,observableExtensions:h,manyObservable:p.manyObservable,entityType:r}}}}});return x.base()()}})(this);this.selfObservable=(function(p){return function(q,t){var r,s;s=q.Id;r=function(){return j.entities[t]};return n(o,s,".",t,j.entities[t],r,"Self")}})(this);this.singleObservable=(function(p){return function(q,v,r){var s,t,u;u=d.From(r.navigationProperties).Single(function(w){return w.name===v});if(!u.to.referentialConstraints.length){return}t=q[u.to.referentialConstraints[0].to[0]];s=function(){return j.entities[u.to.type]};return n(o,t,v,u.to.type,r,s,"Single")}})(this);this.flexibleRelationObservable=(function(p){return function(q,v,r){var s,t,u,w;u=d.From(r.flexibleRelations).Single(function(y){return y.name===v});t=q[u.idProperty];w=q[u.relatedTypeProperty]();s=function(){return j.entities[u.relatedTypeProperty]};return n(o,t,v,w,r,s,"Flexible")}})(this);k={};this.interModelRelationObservable=(function(p){return function(r,w,s){var t,u,v,x,q;v=d.From(s.interModelRelations).Single(function(y){return y.name===w});k[q=v.model]||(k[q]=new b.EntityManager("breeze/"+v.model));u=c.observable().extend({listener:{subscribeActions:function(){return{onSubscribe:function(){var y;if(v.foreignKey!=="Id"){y=b.EntityQuery.from(v.collection).where(v.foreignKey,"==",r[v.key]()).select("Id");return k[v.model].executeQuery(y).then(function(z){return u(z.results[0].Id)})}else{return u(r[v.key]())}},disposePing:function(){},subscribePing:function(){},onDispose:function(){}}}}});x=w;t=function(){return s.model.models[v.model].entities[w]};return n(o,u,w,x,s,t,"InterModel")}})(this);this.rootObservable=(function(p){return function(q,t,s){var r;r=c.observable().extend({listener:{subscribeActions:function(){return{onSubscribe:function(){throw"Illegal attempt to subscribe to unextended observable"}}}},base:{filter:function(){return h.filter},getListenToken:function(w){var u,v;v="Root:"+t+":"+(m++);u=new (e.getMe())(o,w||c.observableArray());u.key=v;u.getDataMerge(function(z){var A,x,y;if(y=d.From(z).SingleOrDefault(void 0,function(B){return B.Type===t})){if(x=d.From(y.Ids).SingleOrDefault(void 0,function(B){return B.Key===q})){if(A=d.From(x.ParameterGroups).SingleOrDefault(void 0,function(C){var B;return(C.Name===(B=C.Name)&&B===v)})){if(typeof A.Value!=="string"){if(!s){return u.data(c.utils.arrayMap(A.Value,function(B){if(u.mixin){return u.mixin(B)}else{return B}}))}else{z=d.From(A.Value).SingleOrDefault(void 0);if(z&&u.mixin){z=u.mixin(z)}return u.data(z)}}}}}});u.getRetrieveRequest(function(z){var x,y,A;A=d.From(z).SingleOrDefault(void 0,function(B){return B.type===t});if(!A){A={ids:[],type:t};z.push(A)}x=d.From(A.ids).SingleOrDefault(void 0,function(B){return B.Id===q});if(!x){x={Id:q,ParameterGroups:[]};A.ids.push(x)}y=d.From(x.ParameterGroups).SingleOrDefault(void 0,function(B){return B.Name===v});if(!y){y={Name:v,Parameters:[]}}x.ParameterGroups.push(y);return y.Parameters});return u.modifyRetrieveRequest(function(x){return x.push({Name:"id",Id:"id",Values:[{Name:"id",Value:q}]})})},listen:function(u){return l.listen(u)},unlisten:function(u){return l.unlisten(u)},extend:function(){return{mixin:{},page:{listener:l},order:{entityType:function(){return j.entities[t]}},filter:{entityType:function(){return j.entities[t]}},title:{},extendListenToken:{},selectMany:{listener:l,manyObservable:p.manyObservable,entityType:function(){return j.entities[t]}}}}}});return r.base()()}})(this)}h.create=function(j,k){var i;i=g.defer();require(["retriever","listener"],function(m,l){h.modelExtensions[j]=new h(k,m.getMe(),l.getMe());return i.resolve()});return i.promise};return h})();return{getMe:function(){return f},initMe:function(){return f.modelExtensions={}}}})}).call(this);